---
title: "HW6"
author: "Ruihan Ding"
date: "2025-12-03"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
```

# Problem 1

Import and clean the data.

```{r}
homicide_df = 
  read_csv("data/homicide-data.csv") |> 
  mutate(
    city_state = str_c(city, ", ", state),
    resolved = if_else(
      disposition == "Closed by arrest", 1, 0
    ),
    victim_age = as.numeric(victim_age),
    victim_sex = fct_relevel(victim_sex, "Female")
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black"),
    victim_sex %in% c("Female", "Male")
  )
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors.

```{r}
fit_Baltimore = 
  homicide_df |> 
  filter(city_state == "Baltimore, MD") |> 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = _, family = binomial())

fit_Baltimore |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    OR = exp(estimate),
    conf.low = exp(conf.low),
    conf.high = exp(conf.high)
  ) |> 
  knitr::kable()
```

The adjusted odds ratio for having a homicide solved, comparing male victims to female victims while holding all other variables constant, is 0.43 with a 95% confidence interval of (0.32, 0.56).

Run glm for each of the cities in the dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims.

```{r}
fit_all = 
  homicide_df |> 
  select(city_state, victim_race, victim_age, victim_sex, resolved) |> 
  nest(data = -city_state) |> 
  mutate(
    fit = map(data, \(df) glm(
    resolved ~ victim_age + victim_race + victim_sex,
    data = df,
    family = binomial()
    )),
  results = map(fit, broom::tidy, conf.int = TRUE)
  ) |> 
  select(city_state, results) |> 
  unnest(results) |> 
  mutate(
    OR = exp(estimate),
    conf.low = exp(conf.low),
    conf.high = exp(conf.high)
  ) |> 
  filter(term == "victim_sexMale") |> 
  select(city_state, OR, conf.low, conf.high)

fit_all
```

Create a plot that shows the estimated ORs and CIs for each city.

```{r}
fit_all |> 
  mutate(
    city_state = fct_reorder(city_state, OR)
  ) |> 
  ggplot(aes(x = city_state, y = OR)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Adjusted odds ratios for solving homicides by city"
  ) +
  theme_minimal()
```

For the majority of cities, the estimated OR is below 1, indicating that homicides involving male victims generally have lower odds of being solved than those involving female victims after adjustment.

# Problem 2













