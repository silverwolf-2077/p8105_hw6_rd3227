HW6
================
Ruihan Ding
2025-12-03

# Problem 1

Import and clean the data.

``` r
homicide_df = 
  read_csv("data/homicide-data.csv") |> 
  mutate(
    city_state = str_c(city, ", ", state),
    resolved = if_else(
      disposition == "Closed by arrest", 1, 0
    ),
    victim_age = as.numeric(victim_age),
    victim_sex = fct_relevel(victim_sex, "Female")
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black"),
    victim_sex %in% c("Female", "Male")
  )
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

For the city of Baltimore, MD, use the glm function to fit a logistic
regression with resolved vs unresolved as the outcome and victim age,
sex and race as predictors.

``` r
fit_Baltimore = 
  homicide_df |> 
  filter(city_state == "Baltimore, MD") |> 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = _, family = binomial())

fit_Baltimore |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    OR = exp(estimate),
    conf.low = exp(conf.low),
    conf.high = exp(conf.high)
  ) |> 
  knitr::kable()
```

| term | estimate | std.error | statistic | p.value | conf.low | conf.high | OR |
|:---|---:|---:|---:|---:|---:|---:|---:|
| (Intercept) | 0.3099810 | 0.1712948 | 1.809635 | 0.0703525 | 0.9757573 | 1.9107826 | 1.3633992 |
| victim_age | -0.0067272 | 0.0033235 | -2.024124 | 0.0429574 | 0.9868059 | 0.9997539 | 0.9932953 |
| victim_raceWhite | 0.8417563 | 0.1747162 | 4.817851 | 0.0000015 | 1.6496269 | 3.2759334 | 2.3204389 |
| victim_sexMale | -0.8544628 | 0.1381762 | -6.183864 | 0.0000000 | 0.3241908 | 0.5575508 | 0.4255117 |

The adjusted odds ratio for having a homicide solved, comparing male
victims to female victims while holding all other variables constant, is
0.43 with a 95% confidence interval of (0.32, 0.56).

Run glm for each of the cities in the dataset, and extract the adjusted
odds ratio (and CI) for solving homicides comparing male victims to
female victims.

``` r
fit_all = 
  homicide_df |> 
  select(city_state, victim_race, victim_age, victim_sex, resolved) |> 
  nest(data = -city_state) |> 
  mutate(
    fit = map(data, \(df) glm(
    resolved ~ victim_age + victim_race + victim_sex,
    data = df,
    family = binomial()
    )),
  results = map(fit, broom::tidy, conf.int = TRUE)
  ) |> 
  select(city_state, results) |> 
  unnest(results) |> 
  mutate(
    OR = exp(estimate),
    conf.low = exp(conf.low),
    conf.high = exp(conf.high)
  ) |> 
  filter(term == "victim_sexMale") |> 
  select(city_state, OR, conf.low, conf.high)

fit_all
```

    ## # A tibble: 47 × 4
    ##    city_state         OR conf.low conf.high
    ##    <chr>           <dbl>    <dbl>     <dbl>
    ##  1 Albuquerque, NM 1.77     0.825     3.76 
    ##  2 Atlanta, GA     1.00     0.680     1.46 
    ##  3 Baltimore, MD   0.426    0.324     0.558
    ##  4 Baton Rouge, LA 0.381    0.204     0.684
    ##  5 Birmingham, AL  0.870    0.571     1.31 
    ##  6 Boston, MA      0.667    0.351     1.26 
    ##  7 Buffalo, NY     0.521    0.288     0.936
    ##  8 Charlotte, NC   0.884    0.551     1.39 
    ##  9 Chicago, IL     0.410    0.336     0.501
    ## 10 Cincinnati, OH  0.400    0.231     0.667
    ## # ℹ 37 more rows

Create a plot that shows the estimated ORs and CIs for each city.

``` r
fit_all |> 
  mutate(
    city_state = fct_reorder(city_state, OR)
  ) |> 
  ggplot(aes(x = city_state, y = OR)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Adjusted odds ratios for solving homicides by city"
  ) +
  theme_minimal()
```

![](p8105_hw6_rd3227_files/figure-gfm/unnamed-chunk-4-1.png)<!-- -->

For the majority of cities, the estimated OR is below 1, indicating that
homicides involving male victims generally have lower odds of being
solved than those involving female victims after adjustment.

# Problem 2

Import data.

``` r
library(p8105.datasets)
data("weather_df")
```

Do bootstrapping.

``` r
bootstrap_results = 
  weather_df |> 
  bootstrap(n = 5000) |> 
  mutate(
    df = map(strap, as_tibble),
    fits = map(df, \(df) lm(tmax ~ tmin + prcp, data = df)),
    results1 = map(fits, broom::glance),
    results2 = map(fits, broom::tidy)
  ) |> 
  mutate(
    r2 = map_dbl(results1, "r.squared"),
    b1 = map_dbl(results2, \(df) df$estimate[2]),
    b2 = map_dbl(results2, \(df) df$estimate[3]),
    beta_ratio = b1/b2
  ) |> 
  select(.id, r2, beta_ratio)
```

Plot the distribution of the estimates.

``` r
bootstrap_results |> 
  ggplot(aes(x = r2)) +
  geom_density() +
  theme_minimal() +
  labs(
    x = expression(r^2),
    y = "Frequency",
    title = "Bootstrap distribution of R-squared"
  )
```

![](p8105_hw6_rd3227_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

``` r
bootstrap_results |> 
  ggplot(aes(x = beta_ratio)) +
  geom_density() +
  theme_minimal() +
  labs(
    x = expression(beta[1] / beta[2]),
    y = "Frequency",
    title = expression("Bootstrap distribution of " ~ beta[1] / beta[2])
  )
```

![](p8105_hw6_rd3227_files/figure-gfm/unnamed-chunk-7-2.png)<!-- -->

Identify the 95% confidence interval of the estimates.

``` r
bootstrap_results |> 
  summarize(
    r2_ci_lower = quantile(r2, 0.025),
    r2_ci_upper = quantile(r2, 0.975),
    beta_ratio_ci_lower = quantile(beta_ratio, 0.025),
    beta_ratio_ci_upper = quantile(beta_ratio, 0.975)
  ) |> 
  knitr::kable()
```

| r2_ci_lower | r2_ci_upper | beta_ratio_ci_lower | beta_ratio_ci_upper |
|------------:|------------:|--------------------:|--------------------:|
|   0.9343281 |   0.9466101 |           -281.4579 |           -126.0586 |
